name: Code Quality

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  lint:
    name: Code Quality Checks
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
    
    - name: Install frontend dependencies
      working-directory: ./frontend
      run: npm ci
    
    - name: Run frontend linter
      working-directory: ./frontend
      run: npm run lint
    
    - name: Check backend code quality
      working-directory: ./backend
      run: |
        echo "## Backend Code Quality" >> $GITHUB_STEP_SUMMARY
        echo "Checking for syntax errors..." >> $GITHUB_STEP_SUMMARY
        node --check index.js && echo "✅ No syntax errors found" >> $GITHUB_STEP_SUMMARY || echo "❌ Syntax errors found" >> $GITHUB_STEP_SUMMARY
    
    - name: Check for console.log statements
      run: |
        echo "## Console Log Check" >> $GITHUB_STEP_SUMMARY
        if grep -r "console\.log" --include="*.js" --include="*.jsx" frontend/src backend/*.js 2>/dev/null | grep -v "node_modules"; then
          echo "⚠️ Found console.log statements in code" >> $GITHUB_STEP_SUMMARY
        else
          echo "✅ No console.log statements found" >> $GITHUB_STEP_SUMMARY
        fi
      continue-on-error: true
    
    - name: Check file sizes
      run: |
        echo "## File Size Report" >> $GITHUB_STEP_SUMMARY
        echo "Large files (>100KB):" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        find . -type f -size +100k -not -path "*/node_modules/*" -not -path "*/.git/*" -not -path "*/package-lock.json" -exec ls -lh {} \; | awk '{print $9, $5}' >> $GITHUB_STEP_SUMMARY || echo "No large files found" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

  format-check:
    name: Format Check
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Check line endings
      run: |
        echo "## Line Ending Check" >> $GITHUB_STEP_SUMMARY
        if git ls-files --eol | grep 'w/crlf'; then
          echo "⚠️ Found files with CRLF line endings" >> $GITHUB_STEP_SUMMARY
          git ls-files --eol | grep 'w/crlf' >> $GITHUB_STEP_SUMMARY
        else
          echo "✅ All files use LF line endings" >> $GITHUB_STEP_SUMMARY
        fi
      continue-on-error: true
    
    - name: Check for trailing whitespace
      run: |
        echo "## Trailing Whitespace Check" >> $GITHUB_STEP_SUMMARY
        if git grep -n '[[:space:]]$' -- '*.js' '*.jsx' '*.json' '*.md' '*.yml' '*.yaml' 2>/dev/null; then
          echo "⚠️ Found trailing whitespace" >> $GITHUB_STEP_SUMMARY
        else
          echo "✅ No trailing whitespace found" >> $GITHUB_STEP_SUMMARY
        fi
      continue-on-error: true
